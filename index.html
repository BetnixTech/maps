
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoLookup ‚Äî Enter address or coordinates</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9fafb;
      color: #333;
    }
    #map {
      height: 60vh;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 1em auto;
      max-width: 960px;
    }
    .controls {
      padding: 1rem 1.5rem;
      background: white;
      max-width: 960px;
      margin: 1em auto 0;
      display: flex;
      gap: 0.75rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    input[type=text] {
      flex-grow: 1;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }
    input[type=text]:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 8px #3b82f6aa;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.6rem 1.3rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 8px rgb(59 130 246 / 0.4);
    }
    button:hover {
      background: #2563eb;
      box-shadow: 0 4px 12px rgb(37 99 235 / 0.6);
    }
    #info {
      max-width: 960px;
      margin: 1em auto 2em;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.07);
      font-size: 1.1rem;
      line-height: 1.5;
      color: #444;
      white-space: pre-line;
    }
    .action-buttons {
      max-width: 960px;
      margin: 0 auto 2em;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .action-buttons button {
      background: #e0e7ff;
      border: none;
      padding: 0.6rem 1.3rem;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      color: #3730a3;
      box-shadow: 0 1px 4px rgb(99 102 241 / 0.3);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .action-buttons button:hover {
      background: #c7d2fe;
      color: #1e3a8a;
    }
    .leaflet-routing-container {
      max-height: 250px;
      overflow-y: auto;
      font-size: 0.9rem;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
      background: white;
      margin-top: 10px;
    }
    .leaflet-popup-content-wrapper {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1rem;
      color: #222;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="query" placeholder="Enter address or lat,lng" autocomplete="off" />
    <button id="searchBtn">Search</button>
    <button id="routeBtn">Show Directions</button>
  </div>
  <div id="map"></div>
  <div id="info"></div>
  <div class="action-buttons" style="padding:1em;">
    <button id="favBtn">‚ù§Ô∏è Add to Favorites</button>
    <button id="wantBtn">üìç Want to Go</button>
    <button id="starBtn">‚≠ê Star</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const map = L.map('map', { center: [20, 0], zoom: 2 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      let userLocation = null;
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLocation = [pos.coords.latitude, pos.coords.longitude];
          L.marker(userLocation).addTo(map).bindPopup('Your Location').openPopup();
        },
        err => {
          console.error('Geolocation error:', err);
          alert(`Unable to get your location: ${err.message}`);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );

      const queryInput = document.getElementById('query');
      const infoDiv = document.getElementById('info');
      const searchBtn = document.getElementById('searchBtn');
      const routeBtn = document.getElementById('routeBtn');
      const favBtn = document.getElementById('favBtn');
      const wantBtn = document.getElementById('wantBtn');
      const starBtn = document.getElementById('starBtn');

      let marker;
      let currentLocation = null;
      let routingControl;

      // Update the URL query param ?q= as user types or searches
      function updateUrlQuery(q) {
        const newUrl = new URL(window.location);
        if (q) {
          newUrl.searchParams.set('q', q);
        } else {
          newUrl.searchParams.delete('q');
        }
        window.history.replaceState(null, '', newUrl.toString());
      }

      async function searchLocation(runFromUrl = false) {
        const query = queryInput.value.trim();
        if (!query) return;

        if (!runFromUrl) updateUrlQuery(query);

        let url;
        if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(query)) {
          const [lat, lon] = query.split(',').map(Number);
          url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
        } else {
          url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        let lat, lon, displayName;
        if (Array.isArray(data) && data.length) {
          lat = parseFloat(data[0].lat);
          lon = parseFloat(data[0].lon);
          displayName = data[0].display_name;
        } else if (data && data.lat && data.lon) {
          lat = parseFloat(data.lat);
          lon = parseFloat(data.lon);
          displayName = data.display_name;
        } else {
          infoDiv.textContent = 'Location not found.';
          return;
        }

        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map).bindPopup(displayName).openPopup();
        map.setView([lat, lon], 14);
        infoDiv.textContent = displayName;
        currentLocation = { lat, lon, name: displayName };
      }

      function saveToList(key) {
        if (!currentLocation) return alert('Search for a location first!');
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        if (!list.some(loc => loc.lat === currentLocation.lat && loc.lon === currentLocation.lon)) {
          list.push(currentLocation);
          localStorage.setItem(key, JSON.stringify(list));
          alert(`Added to ${key.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
        } else alert('Already in list');
      }

      function showRoute() {
        if (!userLocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              userLocation = [pos.coords.latitude, pos.coords.longitude];
              drawRoute();
            },
            err => alert(`Unable to get your location: ${err.message}`),
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        } else {
          drawRoute();
        }
      }

      function drawRoute() {
        if (!currentLocation) return alert('Search for a location first!');
        if (routingControl) map.removeControl(routingControl);

        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLocation[0], userLocation[1]),
            L.latLng(currentLocation.lat, currentLocation.lon)
          ],
          routeWhileDragging: false,
          show: true,
          createMarker: function(i, wp, nWps) {
            return L.marker(wp.latLng).bindPopup(i === 0 ? 'Start' : (i === nWps - 1 ? 'Destination' : 'Waypoint'));
          },
          formatter: new L.Routing.Formatter({
            units: 'imperial',
            language: 'en',
            roundingSensitivity: 10
          })
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
          const route = e.routes[0];
          const distanceMi = (route.summary.totalDistance / 1609.34).toFixed(2);
          const durationMin = (route.summary.totalTime / 60).toFixed(1);
          // Show turn-by-turn instructions as well:
          let instructions = route.instructions.map((instr, i) => {
            return `${i + 1}. ${instr.text}`;
          }).join('\n');

          infoDiv.textContent = `${currentLocation.name}\nDistance: ${distanceMi} miles\nDuration: ${durationMin} minutes\n\nTurn-by-turn:\n${instructions}`;
        });
      }

      // On page load: if URL has ?q=, fill input and search
      const urlParams = new URLSearchParams(window.location.search);
      const qParam = urlParams.get('q');
      if (qParam) {
        queryInput.value = qParam;
        searchLocation(true);
      }

      favBtn.addEventListener('click', () => saveToList('favorites'));
      wantBtn.addEventListener('click', () => saveToList('wantToGo'));
      starBtn.addEventListener('click', () => saveToList('starred'));
      searchBtn.addEventListener('click', () => searchLocation());
      routeBtn.addEventListener('click', showRoute);
      queryInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchLocation(); });
    });
  </script>
</body>
</html>
