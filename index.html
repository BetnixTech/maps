<!doctype html>
<html lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoLookup Advanced üöÄ</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: var(--bg);
      color: var(--fg);
      --bg-light: #f9fafb;
      --fg-light: #333;
      --bg-dark: #121217;
      --fg-dark: #ddd;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --shadow: rgba(0,0,0,0.1);
      transition: background-color 0.3s, color 0.3s;
    }
    body.light {
      --bg: var(--bg-light);
      --fg: var(--fg-light);
      --shadow: rgba(0,0,0,0.1);
    }
    body.dark {
      --bg: var(--bg-dark);
      --fg: var(--fg-dark);
      --shadow: rgba(255,255,255,0.1);
    }

    /* Layout */
    #map {
      height: 60vh;
      width: 100%;
      max-width: 960px;
      margin: 1em auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow);
      filter: var(--map-filter);
      transition: filter 0.3s;
      position: relative;
      background: #e5e5e5;
    }
    #map.fullscreen {
      height: 100vh !important;
      width: 100vw !important;
      max-width: none;
      margin: 0;
      border-radius: 0;
      z-index: 9999;
    }

    .controls {
      max-width: 960px;
      margin: 1em auto 0;
      padding: 1rem 1.5rem;
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
    }
    input[type=text] {
      flex-grow: 1;
      min-width: 200px;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }
    input[type=text]:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 8px var(--primary + "aa");
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.3rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 8px rgb(59 130 246 / 0.4);
    }
    button:hover, button:focus {
      background: var(--primary-hover);
      box-shadow: 0 4px 12px rgb(37 99 235 / 0.6);
      outline: none;
    }
    #info {
      max-width: 960px;
      margin: 1em auto 2em;
      background: var(--bg);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow);
      font-size: 1.1rem;
      line-height: 1.5;
      color: var(--fg);
      white-space: pre-line;
      max-height: 300px;
      overflow-y: auto;
    }
    .action-buttons {
      max-width: 960px;
      margin: 0 auto 2em;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .action-buttons button {
      background: #e0e7ff;
      border: none;
      padding: 0.6rem 1.3rem;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      color: #3730a3;
      box-shadow: 0 1px 4px rgb(99 102 241 / 0.3);
      transition: background-color 0.3s ease, color 0.3s ease;
      flex: 1 1 120px;
      min-width: 120px;
    }
    .action-buttons button:hover {
      background: #c7d2fe;
      color: #1e3a8a;
    }

    .autocomplete-list {
      max-width: 960px;
      margin: 0.25rem auto 1rem;
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg);
      border: 1.5px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 10px var(--shadow);
      font-size: 0.95rem;
      color: var(--fg);
      list-style: none;
      padding: 0;
    }
    .autocomplete-list li {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      user-select: none;
    }
    .autocomplete-list li:hover, .autocomplete-list li.active {
      background: var(--primary);
      color: white;
    }

    .saved-locations {
      max-width: 960px;
      margin: 0 auto 2em;
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow);
      padding: 1rem 1.5rem;
      color: var(--fg);
      font-size: 1rem;
    }
    .saved-locations h3 {
      margin-top: 0;
      margin-bottom: 0.5em;
    }
    .saved-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .saved-list button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      box-shadow: 0 2px 8px rgb(59 130 246 / 0.5);
      transition: background-color 0.3s ease;
    }
    .saved-list button:hover {
      background: var(--primary-hover);
    }
    .saved-list button .remove {
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      color: #222;
      font-weight: bold;
      padding: 0 6px;
      cursor: pointer;
      margin-left: 4px;
      line-height: 1;
      transition: background-color 0.3s ease;
    }
    .saved-list button .remove:hover {
      background: #f44336;
      color: white;
    }

    .directions-panel {
      max-width: 960px;
      margin: 0 auto 2em;
      background: var(--bg);
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow);
      padding: 1rem 1.5rem;
      font-size: 1rem;
      color: var(--fg);
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.4;
    }
    .directions-panel h3 {
      margin-top: 0;
    }
    .directions-step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .directions-step svg {
      width: 20px;
      height: 20px;
      fill: var(--primary);
      flex-shrink: 0;
    }

    /* Dark mode toggle button */
    #themeToggle {
      background: transparent;
      color: var(--primary);
      border: 1.5px solid var(--primary);
      padding: 0.4rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
      flex-shrink: 0;
    }
    #themeToggle:hover {
      background: var(--primary);
      color: white;
    }

    /* Fullscreen toggle button */
    #fullscreenToggle {
      background: transparent;
      color: var(--primary);
      border: 1.5px solid var(--primary);
      padding: 0.4rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
      flex-shrink: 0;
      margin-left: 0.5rem;
    }
    #fullscreenToggle:hover {
      background: var(--primary);
      color: white;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .controls {
        flex-direction: column;
      }
      .action-buttons button {
        flex: 1 1 100%;
      }
      .saved-list button {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
      }
      #fullscreenToggle {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body class="light">

  <div class="controls" role="search" aria-label="Location search">
    <input type="text" id="query" placeholder="Enter address or lat,lng" autocomplete="off" aria-autocomplete="list" aria-controls="autocomplete-list" aria-expanded="false" />
    <button id="searchBtn" aria-label="Search location">Search</button>
    <button id="routeBtn" aria-label="Show directions">Show Directions</button>
    <button id="themeToggle" aria-pressed="false" title="Toggle light/dark mode">üåó</button>
    <button id="fullscreenToggle" aria-pressed="false" title="Toggle fullscreen map">‚õ∂ Fullscreen</button>
  </div>

  <ul id="autocomplete-list" class="autocomplete-list" role="listbox" aria-label="Search suggestions" hidden></ul>

  <div id="map"></div>

  <div id="info" aria-live="polite" aria-atomic="true"></div>

  <div class="action-buttons" role="region" aria-label="Location action buttons" style="padding:1em;">
    <button id="favBtn" aria-label="Add to Favorites">‚ù§Ô∏è Add to Favorites</button>
    <button id="wantBtn" aria-label="Add to Want to Go">üìç Want to Go</button>
    <button id="starBtn" aria-label="Add to Starred">‚≠ê Star</button>
    <button id="copyLinkBtn" aria-label="Copy link to clipboard">üîó Copy Link</button>
  </div>

  <section class="saved-locations" aria-label="Saved locations">
    <h3>Favorites</h3>
    <div id="favoritesList" class="saved-list" role="list"></div>
    <h3>Want to Go</h3>
    <div id="wantToGoList" class="saved-list" role="list"></div>
    <h3>Starred</h3>
    <div id="starredList" class="saved-list" role="list"></div>
  </section>

  <section class="directions-panel" id="directionsPanel" aria-live="polite" aria-atomic="true" hidden>
    <h3>Directions</h3>
    <div id="directionsSteps"></div>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    (function() {
      // Map init
      const map = L.map('map', { center: [20, 0], zoom: 2 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Elements
      const queryInput = document.getElementById('query');
      const infoDiv = document.getElementById('info');
      const searchBtn = document.getElementById('searchBtn');
      const routeBtn = document.getElementById('routeBtn');
      const favBtn = document.getElementById('favBtn');
      const wantBtn = document.getElementById('wantBtn');
      const starBtn = document.getElementById('starBtn');
      const copyLinkBtn = document.getElementById('copyLinkBtn');
      const autocompleteList = document.getElementById('autocomplete-list');

      const favoritesListDiv = document.getElementById('favoritesList');
      const wantToGoListDiv = document.getElementById('wantToGoList');
      const starredListDiv = document.getElementById('starredList');

      const directionsPanel = document.getElementById('directionsPanel');
      const directionsStepsDiv = document.getElementById('directionsSteps');

      const themeToggleBtn = document.getElementById('themeToggle');
      const fullscreenToggleBtn = document.getElementById('fullscreenToggle');

      // Variables
      let marker;
      let currentLocation = null;
      let routingControl;
      let userLocation = null;

      // Helper debounce function
      function debounce(fn, delay) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(null, args), delay);
        };
      }

      // Update URL query param without reload
      function updateUrlQuery(q) {
        const newUrl = new URL(window.location);
        if (q) {
          newUrl.searchParams.set('q', q);
        } else {
          newUrl.searchParams.delete('q');
        }
        window.history.replaceState(null, '', newUrl.toString());
      }

      // Autocomplete fetch
      async function fetchSuggestions(query) {
        if (!query) {
          autocompleteList.hidden = true;
          autocompleteList.innerHTML = '';
          queryInput.setAttribute('aria-expanded', 'false');
          return;
        }
        try {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
          const res = await fetch(url);
          const results = await res.json();
          if (results.length === 0) {
            autocompleteList.hidden = true;
            autocompleteList.innerHTML = '';
            queryInput.setAttribute('aria-expanded', 'false');
            return;
          }
          autocompleteList.innerHTML = results.map((item, i) => `
            <li role="option" tabindex="0" data-lat="${item.lat}" data-lon="${item.lon}" data-display="${item.display_name}">${item.display_name}</li>
          `).join('');
          autocompleteList.hidden = false;
          queryInput.setAttribute('aria-expanded', 'true');
        } catch {
          autocompleteList.hidden = true;
          autocompleteList.innerHTML = '';
          queryInput.setAttribute('aria-expanded', 'false');
        }
      }

      // Handle autocomplete selection
      autocompleteList.addEventListener('click', e => {
        if (e.target.tagName.toLowerCase() === 'li') {
          selectAutocomplete(e.target);
        }
      });
      autocompleteList.addEventListener('keydown', e => {
        const active = document.activeElement;
        if (e.key === 'Enter' && active.parentElement === autocompleteList) {
          selectAutocomplete(active);
        }
        if (e.key === 'ArrowDown') {
          if (document.activeElement.nextElementSibling) {
            document.activeElement.nextElementSibling.focus();
          }
        }
        if (e.key === 'ArrowUp') {
          if (document.activeElement.previousElementSibling) {
            document.activeElement.previousElementSibling.focus();
          } else {
            queryInput.focus();
          }
        }
      });

      function selectAutocomplete(li) {
        const lat = parseFloat(li.dataset.lat);
        const lon = parseFloat(li.dataset.lon);
        const display = li.dataset.display;
        autocompleteList.hidden = true;
        autocompleteList.innerHTML = '';
        queryInput.value = display;
        updateUrlQuery(display);
        showLocationOnMap(lat, lon, display);
      }

      async function showLocationOnMap(lat, lon, displayName) {
        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map).bindPopup(displayName).openPopup();
        map.setView([lat, lon], 14);
        infoDiv.textContent = displayName;
        currentLocation = { lat, lon, name: displayName };
        directionsPanel.hidden = true;
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
      }

      async function searchLocation(runFromUrl = false) {
        const query = queryInput.value.trim();
        if (!query) return;

        if (!runFromUrl) updateUrlQuery(query);

        if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(query)) {
          const [lat, lon] = query.split(',').map(Number);
          const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
          try {
            const res = await fetch(url);
            const data = await res.json();
            const displayName = data.display_name || `Lat:${lat}, Lon:${lon}`;
            showLocationOnMap(lat, lon, displayName);
          } catch {
            infoDiv.textContent = 'Error fetching location data.';
          }
          return;
        }

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (!data.length) {
            infoDiv.textContent = 'Location not found.';
            return;
          }
          const place = data[0];
          showLocationOnMap(parseFloat(place.lat), parseFloat(place.lon), place.display_name);
        } catch {
          infoDiv.textContent = 'Error fetching location data.';
        }
      }

      // Save to lists
      function saveToList(key) {
        if (!currentLocation) return alert('Search for a location first!');
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        if (!list.some(loc => loc.lat === currentLocation.lat && loc.lon === currentLocation.lon)) {
          list.push(currentLocation);
          localStorage.setItem(key, JSON.stringify(list));
          alert(`Added to ${key.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
          renderSavedLists();
        } else {
          alert('Already in list');
        }
      }

      function renderSavedLists() {
        renderList('favorites', favoritesListDiv);
        renderList('wantToGo', wantToGoListDiv);
        renderList('starred', starredListDiv);
      }

      function renderList(key, container) {
        const list = JSON.parse(localStorage.getItem(key) || '[]');
        if (!list.length) {
          container.innerHTML = '<em>No saved locations.</em>';
          return;
        }
        container.innerHTML = '';
        list.forEach((loc, i) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.innerHTML = `
            <span title="${loc.name}">${loc.name.length > 30 ? loc.name.slice(0,27) + '...' : loc.name}</span>
            <span class="remove" aria-label="Remove location" title="Remove location">&times;</span>
          `;
          btn.addEventListener('click', () => {
            queryInput.value = loc.name;
            updateUrlQuery(loc.name);
            showLocationOnMap(loc.lat, loc.lon, loc.name);
          });
          btn.querySelector('.remove').addEventListener('click', e => {
            e.stopPropagation();
            list.splice(i, 1);
            localStorage.setItem(key, JSON.stringify(list));
            renderSavedLists();
          });
          container.appendChild(btn);
        });
      }

      // Directions using routing machine
      function showRoute() {
        if (!userLocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              userLocation = [pos.coords.latitude, pos.coords.longitude];
              drawRoute();
            },
            err => alert(`Unable to get your location: ${err.message}`),
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        } else {
          drawRoute();
        }
      }

      function drawRoute() {
        if (!currentLocation) return alert('Search for a location first!');
        if (routingControl) {
          routingControl.getPlan().setWaypoints([]);
          map.removeControl(routingControl);
          routingControl = null;
        }

        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLocation[0], userLocation[1]),
            L.latLng(currentLocation.lat, currentLocation.lon)
          ],
          routeWhileDragging: true,
          showAlternatives: true,
          show: true,
          fitSelectedRoutes: true,
          lineOptions: { styles: [{ color: '#3b82f6', weight: 5 }] },
          createMarker: function(i, wp, nWps) {
            return L.marker(wp.latLng, {
              draggable: true
            }).bindPopup(i === 0 ? 'Start' : (i === nWps - 1 ? 'Destination' : 'Waypoint'));
          },
          router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
          }),
          formatter: new L.Routing.Formatter({
            units: 'imperial',
            language: 'en',
            roundingSensitivity: 10
          })
        }).addTo(map);

        directionsPanel.hidden = false;
        directionsStepsDiv.innerHTML = '<em>Loading directions...</em>';

        routingControl.on('routesfound', function(e) {
          const route = e.routes[0];
          const distanceMi = (route.summary.totalDistance / 1609.34).toFixed(2);
          const durationMin = (route.summary.totalTime / 60).toFixed(1);

          infoDiv.textContent = `${currentLocation.name}\nDistance: ${distanceMi} miles\nDuration: ${durationMin} minutes`;

          // Build step-by-step directions UI
          const steps = [];
          route.instructions.forEach((instr, i) => {
            steps.push(`
              <div class="directions-step" tabindex="0" aria-label="Step ${i+1}: ${instr.text}">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="${getIconPath(instr.type)}"/></svg>
                <span>${instr.text}</span>
              </div>
            `);
          });

          directionsStepsDiv.innerHTML = steps.join('');
        });
      }

      function getIconPath(type) {
        switch(type) {
          case 'Straight': return 'M12 2 L12 22';
          case 'Left': return 'M16 4 L8 12 L16 20';
          case 'Right': return 'M8 4 L16 12 L8 20';
          case 'SlightLeft': return 'M14 4 L8 12 L14 20';
          case 'SlightRight': return 'M10 4 L16 12 L10 20';
          case 'UTurnLeft': return 'M16 4 A4 4 0 1 1 8 12';
          case 'UTurnRight': return 'M8 4 A4 4 0 1 0 16 12';
          default: return 'M12 2 L12 22';
        }
      }

      // Copy link to clipboard
      copyLinkBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Permalink copied to clipboard!');
        }).catch(() => {
          alert('Failed to copy link.');
        });
      });

      // Debounced autocomplete input
      queryInput.addEventListener('input', debounce(e => {
        fetchSuggestions(e.target.value);
      }, 400));

      // Hide autocomplete on outside click
      document.addEventListener('click', e => {
        if (!autocompleteList.contains(e.target) && e.target !== queryInput) {
          autocompleteList.hidden = true;
          queryInput.setAttribute('aria-expanded', 'false');
        }
      });

      // Event listeners
      searchBtn.addEventListener('click', () => {
        autocompleteList.hidden = true;
        queryInput.setAttribute('aria-expanded', 'false');
        searchLocation();
      });
      routeBtn.addEventListener('click', showRoute);
      queryInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          autocompleteList.hidden = true;
          queryInput.setAttribute('aria-expanded', 'false');
          searchLocation();
        }
      });
      favBtn.addEventListener('click', () => saveToList('favorites'));
      wantBtn.addEventListener('click', () => saveToList('wantToGo'));
      starBtn.addEventListener('click', () => saveToList('starred'));

      // Theme toggle
      themeToggleBtn.addEventListener('click', () => {
        if (document.body.classList.contains('light')) {
          document.body.classList.replace('light', 'dark');
          themeToggleBtn.setAttribute('aria-pressed', 'true');
        } else {
          document.body.classList.replace('dark', 'light');
          themeToggleBtn.setAttribute('aria-pressed', 'false');
        }
      });

      // Fullscreen toggle
      fullscreenToggleBtn.addEventListener('click', () => {
        const mapEl = document.getElementById('map');
        if (!document.fullscreenElement) {
          mapEl.requestFullscreen().then(() => {
            mapEl.classList.add('fullscreen');
            fullscreenToggleBtn.setAttribute('aria-pressed', 'true');
            fullscreenToggleBtn.textContent = '‚ùé Exit Fullscreen';
            map.invalidateSize();
          }).catch(console.error);
        } else {
          document.exitFullscreen().then(() => {
            mapEl.classList.remove('fullscreen');
            fullscreenToggleBtn.setAttribute('aria-pressed', 'false');
            fullscreenToggleBtn.textContent = '‚õ∂ Fullscreen';
            map.invalidateSize();
          }).catch(console.error);
        }
      });

      // When fullscreen changes (user presses ESC or other)
      document.addEventListener('fullscreenchange', () => {
        const mapEl = document.getElementById('map');
        if (!document.fullscreenElement) {
          mapEl.classList.remove('fullscreen');
          fullscreenToggleBtn.setAttribute('aria-pressed', 'false');
          fullscreenToggleBtn.textContent = '‚õ∂ Fullscreen';
          map.invalidateSize();
        }
      });

      // Initial load from URL param
      function loadFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const q = params.get('q');
        if (q) {
          queryInput.value = q;
          searchLocation(true);
        }
      }

      // Initialize
      function init() {
        loadFromUrl();
        renderSavedLists();

        // Try to get user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              userLocation = [pos.coords.latitude, pos.coords.longitude];
              L.marker(userLocation).addTo(map).bindPopup('Your Location').openPopup();
            },
            err => {
              console.warn('Geolocation failed or permission denied.');
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
          );
        }
      }

      init();

    })();
  </script>

</body>
</html>
